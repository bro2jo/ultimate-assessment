<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Successfully Submitted</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* CSS Variables for consistent theming */
        :root {
            --primary-color: #ff9123;
            --secondary-color: #7a1fbf;
            --dark-bg: #1f1f1f;
            --darker-bg: #2d2d2d;
            --text-primary: #fff;
            --text-secondary: #e5e5e5;
            --text-muted: #999;
            --gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --border-radius: 12px;
            --spacing-sm: 10px;
            --spacing-md: 20px;
            --spacing-lg: 30px;
        }

        /* Core Layout */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
        }
        /* Canvas Element */
        #radarChart {
            width: 100% !important;
            height: auto !important;
        }
        /* Success Page Styles */
        .success-container {
            max-width: 800px;
            padding: 40px;
            background: var(--darker-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .success-header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--spacing-md);
        }

        .success-icon i {
            font-size: 40px;
            color: var(--text-primary);
        }

        /* Typography */
        h1 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 28px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 18px;
            margin-bottom: var(--spacing-lg);
        }

        /* Next Steps Section */
        .next-steps {
            background: rgba(255, 145, 35, 0.1);
            border-radius: var(--border-radius);
            padding: 25px;
            margin: var(--spacing-lg) 0;
        }

        .next-steps h2 {
            color: var(--primary-color);
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* Steps List */
        .steps-list {
            list-style: none;
        }

        .steps-list li {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            color: var(--text-secondary);
        }

        .steps-list i {
            color: var(--primary-color);
            margin-top: 5px;
        }

        /* Assessment Results */
        .assessment-results {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
        }

        .results-group {
            margin-bottom: var(--spacing-md);
        }

        .results-group h3 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
            font-size: 16px;
        }

        .skill-result {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .skill-result .rating {
            font-weight: bold;
        }

        /* Meta Information */
        .assessment-meta {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: var(--spacing-sm);
            margin-bottom: 15px;
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: var(--spacing-lg);
        }

        .button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--gradient);
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s ease;
            text-align: center;
            cursor: pointer;
            border: none;
            font-size: 16px;
        }

        .button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 145, 35, 0.3);
        }

        .button.outline {
            background: transparent;
            border: 2px solid var(--primary-color);
        }

        /* Reminder Box */
        .reminder-box {
            background: rgba(122, 31, 191, 0.1);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-top: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .reminder-icon {
            font-size: 24px;
            color: var(--secondary-color);
        }

        .reminder-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Radar Chart */
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin-bottom: var(--spacing-lg);
        }

        /* Level Card Styles */
        .level-card {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }

        .level-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        .level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .level-info h2 {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #levelTitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .level-icon {
            font-size: 48px;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .level-icon:hover {
            transform: scale(1.1);
        }

        .progress-track {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            height: 8px;
            overflow: hidden;
            margin: 8px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            transition: width 0.5s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        #progressPercent {
            text-align: right;
        }

        #progressPercent::after {
            content: ' / 100';
        }

        /* Achievement Cards */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: var(--spacing-lg);
        }

        .achievement-card {
            background: var(--darker-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s ease;
        }

        .achievement-card:hover {
            transform: translateY(-2px);
        }

        .achievement-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .achievement-locked {
            display: none;  /* This will completely hide locked achievements */
            opacity: 0.5;
            filter: grayscale(1);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: var(--darker-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Development Path */
        .development-path {
            background: var(--darker-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: var(--spacing-lg);
        }

        .section-title {
            color: var(--primary-color);
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .path-step {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step-content h4 {
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .step-content p {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Text utility classes */
        .text-muted {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Chart Tooltip Styles */
        #chartjs-tooltip {
            position: absolute;
            pointer-events: none;
            opacity: 0;
            transition: all .1s ease;
            background: rgba(31, 31, 31, 0.9);
            border-radius: 8px;
            color: #fff;
            padding: 10px;
            box-shadow: 0px 0px 10px rgba(0,0,0,0.5);
            transform: translate(-50%, 0);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <main class="success-container">
        <!-- Header Section -->
        <header class="success-header">
            <div class="success-icon" aria-hidden="true">
                <i class="fas fa-check"></i>
            </div>
            <h1>Assessment Submitted Successfully!</h1>
            <p class="subtitle">Thank you for completing your Ultimate skills self-assessment.</p>
        </header>
        
        <!-- Next Steps Section -->
        <section class="next-steps">
            <h2><i class="fas fa-forward" aria-hidden="true"></i> Next Steps</h2>
            <ul class="steps-list">
                <li>
                    <i class="fas fa-bullseye" aria-hidden="true"></i>
                    <div>Review your results against your personal goals and team's strategic needs. Consider which skills most impact your role and playing style.</div>
                </li>
                <li>
                    <i class="fas fa-route" aria-hidden="true"></i>
                    <div>Make a focused decision: either master your strengths further (becoming exceptional in key areas) or develop specific weaker skills that align with your goals.</div>
                </li>
                <li>
                    <i class="fas fa-tasks" aria-hidden="true"></i>
                    <div>Create a specific training plan with measurable targets. Focus on quality practice in 2-3 key areas rather than trying to improve everything at once.</div>
                </li>
            </ul>
        </section>
        <aside class="reminder-box" role="note">
            <i class="fas fa-bell reminder-icon" aria-hidden="true"></i>
            <div class="reminder-text">
                <strong>Pro Tip:</strong> Take photos or videos of your practice sessions. They're great for tracking progress and getting feedback.
            </div>
        </aside>
    
        <!-- Assessment Results Section -->
        <section class="assessment-results">
            <div class="level-card">
                <div class="level-header">
                    <div class="level-info">
                        <h2>Current Rating: <span id="playerRating" aria-live="polite">0</span></h2>
                        <p id="levelTitle">Ultimate Skills Assessment</p>
                    </div>
                    <div class="level-icon" id="levelIcon" aria-hidden="true">
                        <i class="fas fa-star"></i>
                    </div>
                </div>
                <div class="progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-fill" id="levelProgress"></div>
                </div>
                <div class="progress-labels">
                    <span></span>  <!-- Empty span to maintain flex spacing -->
                    <span id="progressPercent" aria-live="polite">0</span>
                </div>
            </div>
    
            <div class="chart-container" role="img" aria-label="Skills radar chart">
                <canvas id="radarChart"></canvas>
            </div>
    
            <div class="achievements-grid" role="list">
                <!-- Achievement Cards -->
                <div class="achievement-card achievement-locked" id="masterHandler" role="listitem">
                    <div class="achievement-icon" style="background: linear-gradient(135deg, #fbbf24, #d97706);" aria-hidden="true">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div>
                        <h3>Master Handler</h3>
                        <p class="text-muted">Exceptional throwing skills</p>
                    </div>
                </div>
                <div class="achievement-card achievement-locked" id="speedDemon" role="listitem">
                    <div class="achievement-icon" style="background: linear-gradient(135deg, #60a5fa, #2563eb);" aria-hidden="true">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div>
                        <h3>Speed Demon</h3>
                        <p class="text-muted">Outstanding cutting ability</p>
                    </div>
                </div>
                <div class="achievement-card achievement-locked" id="strategist" role="listitem">
                    <div class="achievement-icon" style="background: linear-gradient(135deg, #a855f7, #7c3aed);" aria-hidden="true">
                        <i class="fas fa-chess"></i>
                    </div>
                    <div>
                        <h3>Strategic Mind</h3>
                        <p class="text-muted">High game IQ</p>
                    </div>
                </div>
                <div class="achievement-card achievement-locked" id="movementMaster" role="listitem">
                    <div class="achievement-icon" style="background: linear-gradient(135deg, #22c55e, #059669);" aria-hidden="true">
                        <i class="fas fa-running"></i>
                    </div>
                    <div>
                        <h3>Movement Master</h3>
                        <p class="text-muted">Exceptional cutting skills</p>
                    </div>
                </div>
                <div class="achievement-card achievement-locked" id="defenseMaster" role="listitem">
                    <div class="achievement-icon" style="background: linear-gradient(135deg, #60a5fa, #2563eb);" aria-hidden="true">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div>
                        <h3>Defense Specialist</h3>
                        <p class="text-muted">Superior defensive skills</p>
                    </div>
                </div>
                <div class="achievement-card achievement-locked" id="athleticExcellence" role="listitem">
                    <div class="achievement-icon" style="background: linear-gradient(135deg, #f472b6, #db2777);" aria-hidden="true">
                        <i class="fas fa-dumbbell"></i>
                    </div>
                    <div>
                        <h3>Athletic Excellence</h3>
                        <p class="text-muted">Exceptional physical ability</p>
                    </div>
                </div>
                <div class="achievement-card achievement-locked" id="ultimate_master" role="listitem">
                    <div class="achievement-icon" style="background: linear-gradient(135deg, #f59e0b, #b45309);" aria-hidden="true">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div>
                        <h3>Ultimate Master</h3>
                        <p class="text-muted">Achieved perfect mastery</p>
                    </div>
                </div>
                <!-- (Optional) Add new achievement card here if needed -->
            </div>
    
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <i class="fas fa-trophy" aria-hidden="true"></i>
                        <span>Top Skill</span>
                    </div>
                    <div class="stat-value" id="topSkill" aria-live="polite">-</div>
                    <div class="stat-label" id="topSkillRating">0/10</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <i class="fas fa-bullseye" aria-hidden="true"></i>
                        <span>Focus Area</span>
                    </div>
                    <div class="stat-value" id="focusSkill" aria-live="polite">-</div>
                    <div class="stat-label" id="focusSkillRating">0/10</div>
                </div>
            </div>

            <!-- Added resultsSummary div -->
            <div id="resultsSummary">
                <!-- Results will be populated by JavaScript -->
            </div>
        </section>
    
        <div class="action-buttons">
            <a href="/" class="button" role="button">
                <i class="fas fa-redo" aria-hidden="true"></i>
                Take Another Assessment
            </a>
            <button type="button" id="saveButton" class="button outline">
                <i class="fas fa-download" aria-hidden="true"></i>
                Save Results as PDF
            </button>
        </div>
    </main>
    
    <!-- PDF Template -->
    <div class="pdf-template" id="pdfTemplate" hidden>
        <div class="pdf-header">
            <h1>Ultimate Skills Assessment Report</h1>
            <div class="assessment-date" id="pdfDate"></div>
        </div>
    
        <div class="pdf-meta">
            <div class="pdf-meta-item">
                <strong>Player Name:</strong>
                <span id="pdfName"></span>
            </div>
            <div class="pdf-meta-item">
                <strong>Assessment Date:</strong>
                <span id="pdfAssessmentDate"></span>
            </div>
        </div>
    
        <div id="pdfSkillSections">
            <!-- Skill sections will be populated by JavaScript -->
        </div>
    
        <div class="pdf-summary">
            <h3>Assessment Summary</h3>
            <ul id="pdfSummaryPoints">
                <!-- Summary points will be populated by JavaScript -->
            </ul>
        </div>
    </div>

    <script>
        // Configuration Constants
        const SKILL_CATEGORIES = {
            'Cutting & Movement': [
                'isolation_cutting',
                'continuation_cutting',
                'angles',
                'fakes_footwork',
                'timing_field_vision',
                'decisiveness',
                'catching',
                'zone_offense',
                'reading_the_disc',
                'handler_cutting'
            ],
            'Throwing Skills': ['throwing', 'disc_moves'],
            'Defense': ['marking', 'downfield_defense', 'handler_defense'],
            'Fitness & Athleticism': [
                'speed_explosiveness',
                'endurance',
                'vertical_leap',
                'change_of_direction',
                'boxing_out',
                'laying_out',
                'recovery',
                'flexibility_mobility',
                'injury_prevention'
            ],
            'Strategy & Game IQ': ['defensive_strategy', 'offensive_strategy', 'mental_game', 'feedback_implementation'] // Added 'feedback_implementation'
        };

        const LEVEL_CONFIG = {
            0: { title: 'Beginner', description: 'Starting Your Ultimate Journey', icon: 'seedling' },
            20: { title: 'Developing', description: 'Building Fundamental Skills', icon: 'child' },
            40: { title: 'Intermediate', description: 'Refining Your Game', icon: 'running' },
            60: { title: 'Advanced', description: 'Mastering Complex Skills', icon: 'star' },
            80: { title: 'Elite', description: 'Exceptional Performance', icon: 'crown' },
            95: { title: 'Master', description: 'Ultimate Skills Master', icon: 'trophy' }
        };

        const ACHIEVEMENT_THRESHOLDS = {
            masterHandler: { skill: 'throwing', threshold: 8 },
            speedDemon: { skills: [
                'isolation_cutting',
                'continuation_cutting',
                'angles',
                'fakes_footwork',
                'timing_field_vision',
                'decisiveness',
                'catching',
                'zone_offense',
                'reading_the_disc'
            ], threshold: 8 }, // Updated to multiple skills
            strategist: { skill: 'mental_game', threshold: 8 },
            athleticExcellence: { category: 'Fitness & Athleticism', threshold: 8 },
            movementMaster: { skills: [
                'isolation_cutting',
                'continuation_cutting',
                'angles',
                'fakes_footwork',
                'timing_field_vision',
                'decisiveness',
                'catching',
                'zone_offense',
                'reading_the_disc'
            ], threshold: 9 } // New achievement based on detailed cutting skills
            // (Optional) Add new achievement thresholds here if needed
            // e.g., feedbackImplementation: { skill: 'feedback_implementation', threshold: 8 }
        };

        class AppError extends Error {
            constructor(message, context) {
                super(message);
                this.context = context;
                this.name = 'AppError';
            }
        }

        const ErrorHandler = {
            handleError(error, context) {
                console.error(`Error in ${context}:`, error);
                this.showUserError(context);
                return null;
            },

            showUserError(context) {
                const errorMessages = {
                    'data-retrieval': 'Unable to retrieve assessment data. Please try again.',
                    'pdf-generation': 'Error generating PDF. Please try again.',
                    'chart-creation': 'Unable to create skill chart.',
                    'ui-update': 'Error updating display.',
                    'validation': 'Invalid data format.',
                    'default': 'An unexpected error occurred. Please try again.'
                };
                alert(errorMessages[context] || errorMessages.default);
            }
        };

        class Utils {
            static isValidSkill(skill) {
                return Object.values(SKILL_CATEGORIES).flat().includes(skill);
            }

            static sanitizeInput(input) {
                if (typeof input !== 'string') return '';
                const entities = { '<': '&lt;', '>': '&gt;', '&': '&amp;' };
                return input.replace(/[<>&]/g, char => entities[char] || char);
            }

            static formatSkillName(skill) {
                if (typeof skill !== 'string') return '';
                return skill
                    .replace(/_/g, ' ')
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            }

            static validateRating(rating) {
                const num = Number(rating);
                return !isNaN(num) && num >= 1 && num <= 10 ? num : 5;
            }

            static getUrlParams() {
                try {
                    return Object.fromEntries(new URLSearchParams(window.location.search).entries());
                } catch (error) {
                    ErrorHandler.handleError(error, 'url-params');
                    return {};
                }
            }

            static calculateAverage(values) {
                if (!values.length) return 0;
                return values.reduce((a, b) => a + b, 0) / values.length;
            }

            static sanitizeFileName(name) {
                return name.toLowerCase().replace(/[^a-z0-9]/g, '-');
            }
        }

        class DOMHelper {
            static getElement(id) {
                const element = document.getElementById(id);
                if (!element) {
                    throw new AppError(`Element with id '${id}' not found`, 'dom-access');
                }
                return element;
            }

            static setContent(id, content) {
                try {
                    this.getElement(id).textContent = content;
                } catch (error) {
                    ErrorHandler.handleError(error, 'dom-update');
                }
            }

            static setHTML(id, html) {
                try {
                    this.getElement(id).innerHTML = html;
                } catch (error) {
                    ErrorHandler.handleError(error, 'dom-update');
                }
            }

            static toggleClass(id, className, condition) {
                try {
                    const element = this.getElement(id);
                    element.classList.toggle(className, condition);
                } catch (error) {
                    ErrorHandler.handleError(error, 'dom-update');
                }
            }

            static setStyle(id, property, value) {
                try {
                    this.getElement(id).style[property] = value;
                } catch (error) {
                    ErrorHandler.handleError(error, 'dom-update');
                }
            }
        }

        class AssessmentDataManager {
            static getAssessmentData() {
                try {
                    const storedData = localStorage.getItem('skillAssessment');
                    if (storedData) {
                        return this.validateAssessmentData(JSON.parse(storedData));
                    }

                    const urlParams = Utils.getUrlParams();
                    if (Object.keys(urlParams).length === 0) return null;

                    const assessmentData = {
                        name: Utils.sanitizeInput(urlParams.name) || 'Anonymous',
                        email: Utils.sanitizeInput(urlParams.email) || '',
                        date: new Date().toLocaleDateString(),
                        ratings: {}
                    };

                    Object.entries(urlParams)
                        .filter(([key]) => Utils.isValidSkill(key))
                        .forEach(([key, value]) => {
                            assessmentData.ratings[key] = Utils.validateRating(value);
                        });

                    return assessmentData;
                } catch (error) {
                    return ErrorHandler.handleError(error, 'data-retrieval');
                }
            }

            static validateAssessmentData(data) {
                if (!data || typeof data !== 'object') {
                    throw new AppError('Invalid assessment data structure', 'validation');
                }

                return {
                    name: Utils.sanitizeInput(data.name) || 'Anonymous',
                    email: Utils.sanitizeInput(data.email) || '',
                    date: data.date || new Date().toLocaleDateString(),
                    ratings: Object.entries(data.ratings || {})
                        .filter(([key]) => Utils.isValidSkill(key))
                        .reduce((acc, [key, value]) => {
                            acc[key] = Utils.validateRating(value);
                            return acc;
                        }, {})
                };
            }
        }

        class SkillsAnalyzer {
            static calculateSkillSummary(ratings) {
                const summary = {
                    strongestCategory: '',
                    strongestScore: 0,
                    weakestCategory: '',
                    weakestScore: 10,
                    topSkills: [],
                    improvementAreas: []
                };

                Object.entries(SKILL_CATEGORIES).forEach(([category, skills]) => {
                    const validSkills = skills.filter(skill => ratings[skill]);
                    if (!validSkills.length) return;

                    const categoryAvg = Utils.calculateAverage(
                        validSkills.map(skill => Number(ratings[skill]))
                    );

                    if (categoryAvg > summary.strongestScore) {
                        summary.strongestScore = categoryAvg;
                        summary.strongestCategory = category;
                    }
                    if (categoryAvg < summary.weakestScore) {
                        summary.weakestScore = categoryAvg;
                        summary.weakestCategory = category;
                    }

                    validSkills.forEach(skill => {
                        const rating = Number(ratings[skill]);
                        if (rating >= 8) summary.topSkills.push({ name: skill, rating });
                        if (rating <= 4) summary.improvementAreas.push({ name: skill, rating });
                    });
                });

                return summary;
            }

            static calculateRating(ratings) {
                const values = Object.values(ratings);
                return Math.round(Utils.calculateAverage(values) * 10);
            }

            static calculateLevel(ratings) {
                const avgRating = Utils.calculateAverage(Object.values(ratings)) * 10;
                const levels = Object.keys(LEVEL_CONFIG).map(Number).sort((a, b) => a - b);
                
                const currentLevel = levels.reduce((acc, level) => 
                    avgRating >= level ? level : acc, 0);
                
                const nextLevel = levels.find(level => level > currentLevel) || 100;
                const progress = Math.min(100, Math.max(0, avgRating));
                
                return {
                    currentLevel,
                    nextLevel,
                    progress: Math.round(progress),
                    config: LEVEL_CONFIG[currentLevel]
                };
            }
        }

        class UIManager {
            static init() {
                try {
                    const data = AssessmentDataManager.getAssessmentData();
                    if (!data) return;

                    this.updateUI(data);
                    ChartManager.initializeRadarChart(data);
                } catch (error) {
                    ErrorHandler.handleError(error, 'initialization');
                }
            }

            static updateUI(data) {
                try {
                    this.updateAchievements(data.ratings);
                    this.updateStats(data.ratings);
                    this.updateLevel(data.ratings);
                    this.updateResults(data);
                    this.updateLevelTitle(data.name);
                } catch (error) {
                    ErrorHandler.handleError(error, 'ui-update');
                }
            }

            static updateAchievements(ratings) {
                Object.entries(ACHIEVEMENT_THRESHOLDS).forEach(([id, { skill, skills, category, threshold }]) => {
                    if (skill) {
                        // Achievement based on individual skill
                        DOMHelper.toggleClass(id, 'achievement-locked', ratings[skill] < threshold);
                    } else if (skills) {
                        // Achievement based on multiple skills
                        const hasAllSkills = skills.every(skill => ratings[skill] >= threshold);
                        DOMHelper.toggleClass(id, 'achievement-locked', !hasAllSkills);
                    } else if (category) {
                        // Achievement based on category average
                        const categorySkills = SKILL_CATEGORIES[category];
                        const validSkills = categorySkills.filter(skill => ratings[skill]);
                        const categoryAvg = validSkills.length ? Utils.calculateAverage(validSkills.map(skill => ratings[skill])) : 0;
                        DOMHelper.toggleClass(id, 'achievement-locked', categoryAvg < threshold);
                    }
                });

                const hasPerfectSkill = Object.values(ratings).some(rating => Number(rating) === 10);
                DOMHelper.toggleClass('ultimate_master', 'achievement-locked', !hasPerfectSkill);
            }

            static updateStats(ratings) {
                const skillRatings = Object.entries(ratings)
                    .map(([skill, value]) => ({ name: skill, value: Number(value) }))
                    .sort((a, b) => b.value - a.value);

                const highestValue = skillRatings[0]?.value || 0;
                const highestSkills = skillRatings.filter(skill => skill.value === highestValue);
                const lowestValue = skillRatings[skillRatings.length - 1]?.value || 0;
                const lowestSkills = skillRatings.filter(skill => skill.value === lowestValue);

                DOMHelper.setContent('topSkill', 
                    highestSkills.length === 1 ? Utils.formatSkillName(highestSkills[0].name) 
                    : `${highestSkills.length} Skills Tied`);
                DOMHelper.setContent('topSkillRating', `${highestValue}/10`);

                DOMHelper.setContent('focusSkill',
                    lowestSkills.length === 1 ? Utils.formatSkillName(lowestSkills[0].name)
                    : `${lowestSkills.length} Skills Tied`);
                DOMHelper.setContent('focusSkillRating', `${lowestValue}/10`);
            }

            static updateLevel(ratings) {
                const levelData = SkillsAnalyzer.calculateLevel(ratings);
                
                DOMHelper.setContent('playerRating', levelData.progress);
                DOMHelper.setContent('levelTitle', levelData.config.description);
                DOMHelper.setStyle('levelProgress', 'width', `${levelData.progress}%`);
                DOMHelper.setContent('progressPercent', levelData.progress);
                
                DOMHelper.setHTML('levelIcon', `<i class="fas fa-${levelData.config.icon}"></i>`);
            }

            static updateLevelTitle(name) {
                DOMHelper.setContent('levelTitle', `${name} - ${new Date().toLocaleDateString()}`);
            }

            static updateResults(data) {
                const resultsDiv = document.getElementById('resultsSummary');
                if (!resultsDiv) {
                    // If the element doesn't exist, create it within the assessment-results section
                    const assessmentResults = document.querySelector('.assessment-results');
                    const newResultsDiv = document.createElement('div');
                    newResultsDiv.id = 'resultsSummary';
                    assessmentResults.appendChild(newResultsDiv);
                }

                const metaHtml = `
                    <div class="assessment-meta">
                        <div>Name: ${data.name}</div>
                        <div>Date: ${data.date}</div>
                    </div>
                `;

                const resultsHtml = Object.entries(SKILL_CATEGORIES)
                    .map(([category, skills]) => {
                        const categorySkills = skills
                            .filter(skill => data.ratings[skill])
                            .map(skill => `
                                <div class="skill-result">
                                    <span>${Utils.formatSkillName(skill)}</span>
                                    <span class="rating">${data.ratings[skill]}/10</span>
                                </div>
                            `).join('');

                        return categorySkills ? `
                            <div class="results-group">
                                <h3>${category}</h3>
                                ${categorySkills}
                            </div>
                        ` : '';
                    })
                    .join('');

                DOMHelper.setHTML('resultsSummary', metaHtml + resultsHtml);
            }
        }

        class PDFManager {
            static async generatePDF(data) {
                try {
                    await this.populatePDFTemplate(data);
                    const element = DOMHelper.getElement('pdfTemplate');
                    element.classList.add('visible');

                    const options = {
                        margin: [10, 20, 20, 20],
                        filename: `ultimate-skills-assessment-${Utils.sanitizeFileName(data.name)}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                        pagebreak: { mode: ['css'] }
                    };

                    await html2pdf().set(options).from(element).save();
                    element.classList.remove('visible');

                } catch (error) {
                    ErrorHandler.handleError(error, 'pdf-generation');
                }
            }

            static async populatePDFTemplate(data) {
                try {
                    const elements = ['pdfName', 'pdfDate', 'pdfAssessmentDate', 'pdfSkillSections', 'pdfSummaryPoints']
                        .map(id => ({ id, element: document.getElementById(id) }));

                    if (elements.some(({ element }) => !element)) {
                        throw new AppError('Missing PDF template elements', 'pdf-generation');
                    }

                    elements.forEach(({ id, element }) => {
                        if (id.includes('Date')) {
                            element.innerText = data.date;
                        } else if (id === 'pdfName') {
                            element.innerText = data.name;
                        }
                    });

                    DOMHelper.setHTML('pdfSkillSections', this.generateSkillSections(data.ratings));
                    DOMHelper.setHTML('pdfSummaryPoints', this.generateSummaryPoints(data.ratings));

                } catch (error) {
                    throw new AppError('Error populating PDF template', 'pdf-generation');
                }
            }

            static generateSkillSections(ratings) {
                return Object.entries(SKILL_CATEGORIES)
                    .map(([category, skills]) => {
                        const validSkills = skills.filter(skill => ratings[skill]);
                        if (!validSkills.length) return '';

                        const skillsList = validSkills.map(skill => `
                            <div class="pdf-skill-item">
                                <span class="pdf-skill-name">${Utils.formatSkillName(skill)}</span>
                                <div style="display: flex; align-items: center;">
                                    <span class="pdf-rating-value">${ratings[skill]}/10</span>
                                    <div class="pdf-rating-bar">
                                        <div class="pdf-rating-fill" style="width: ${ratings[skill] * 10}%"></div>
                                    </div>
                                </div>
                            </div>
                        `).join('');

                        return `
                            <div class="pdf-section">
                                <h2>${category}</h2>
                                <div class="pdf-skill-grid">
                                    ${skillsList}
                                </div>
                            </div>
                        `;
                    })
                    .join('');
            }

            static generateSummaryPoints(ratings) {
                const summary = SkillsAnalyzer.calculateSkillSummary(ratings);
                const points = [
                    `Strongest Category: ${summary.strongestCategory} (Avg: ${summary.strongestScore.toFixed(1)})`,
                    `Areas for Development: ${summary.weakestCategory} (Avg: ${summary.weakestScore.toFixed(1)})`,
                    summary.topSkills.length > 0 ? 
                        `Top Skills: ${summary.topSkills.map(s => Utils.formatSkillName(s.name)).join(', ')}` : null,
                    summary.improvementAreas.length > 0 ? 
                        `Focus Areas: ${summary.improvementAreas.map(s => Utils.formatSkillName(s.name)).join(', ')}` : null
                ].filter(Boolean);

                return points.map(point => `<li>${point}</li>`).join('');
            }
        }

        class ChartManager {
            static detailedSkills = {};  // Add static class property to store skills data

            static initializeRadarChart(data) {
                try {
                    const ctx = DOMHelper.getElement('radarChart').getContext('2d');
                    const chartData = this.prepareChartData(data);
                    
                    new Chart(ctx, {
                        type: 'radar',
                        data: chartData,
                        options: this.getChartOptions()
                    });
                } catch (error) {
                    ErrorHandler.handleError(error, 'chart-creation');
                }
            }

            static prepareChartData(data) {
                const labels = Object.keys(SKILL_CATEGORIES);
                this.detailedSkills = {};  // Reset detailed skills before populating

                const dataPoints = labels.map(category => {
                    const skills = SKILL_CATEGORIES[category];
                    const validSkills = skills.filter(skill => data.ratings[skill]);
                    const average = validSkills.length > 0
                        ? Utils.calculateAverage(validSkills.map(skill => data.ratings[skill]))
                        : 0;

                    this.detailedSkills[category] = validSkills.map(skill => ({
                        name: Utils.formatSkillName(skill),
                        value: data.ratings[skill]
                    }));

                    return average;
                });

                return {
                    labels,
                    datasets: [{
                        label: 'Skill Ratings',
                        data: dataPoints,
                        backgroundColor: 'rgba(122, 31, 191, 0.2)',
                        borderColor: 'rgba(255, 145, 35, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(255, 145, 35, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(255, 145, 35, 1)'
                    }]
                };
            }
            static getChartOptions() {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 10,
                            ticks: { display: false },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
                            pointLabels: {
                                color: '#e5e5e5',
                                font: { size: 14 }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false  // This will hide the legend completely
                        },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                ChartManager.handleChartTooltip(context);  // Changed to explicitly reference ChartManager
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1200,
                        easing: 'easeOutBounce'
                    }
                };
            }
            static handleChartTooltip(context) {
                const { chart, tooltip } = context;
                let tooltipEl = document.getElementById('chartjs-tooltip');

                // Create or get tooltip element
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'chartjs-tooltip';
                    document.body.appendChild(tooltipEl);
                }

                // Handle hide state
                if (tooltip.opacity === 0) {
                    tooltipEl.style.opacity = 0;
                    return;
                }

                // Enhanced tooltip styling
                tooltipEl.innerHTML = `
                    <div class="tooltip-content">
                        <div class="tooltip-header"></div>
                        <div class="tooltip-body"></div>
                    </div>
                `;

                // Style improvements
                Object.assign(tooltipEl.style, {
                    opacity: 1,
                    position: 'absolute',
                    background: 'rgba(45, 45, 45, 0.95)',
                    color: '#fff',
                    borderRadius: '8px',
                    padding: '12px',
                    pointerEvents: 'none',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                    transition: 'all .1s ease',
                    fontSize: '14px',
                    border: '1px solid rgba(255,255,255,0.1)',
                    minWidth: '200px',
                    maxWidth: '280px'
                });

                // Position the tooltip
                const position = chart.canvas.getBoundingClientRect();
                tooltipEl.style.left = position.left + window.pageXOffset + tooltip.caretX + 'px';
                tooltipEl.style.top = position.top + window.pageYOffset + tooltip.caretY + 'px';

                // Populate tooltip content
                if (tooltip.body) {
                    const index = tooltip.dataPoints[0].dataIndex;
                    const category = chart.data.labels[index];
                    const average = chart.data.datasets[0].data[index].toFixed(1);
                    const skills = this.detailedSkills[category] || [];

                    const headerContent = tooltipEl.querySelector('.tooltip-header');
                    const bodyContent = tooltipEl.querySelector('.tooltip-body');

                    // Enhanced header styling
                    headerContent.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                    headerContent.style.marginBottom = '8px';
                    headerContent.style.paddingBottom = '8px';
                    headerContent.innerHTML = `
                        <div style="font-weight: 600; font-size: 16px; color: #ff9123; margin-bottom: 4px;">
                            ${category}
                        </div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.9);">
                            Average: ${average}/10
                        </div>
                    `;

                    // Enhanced skills list
                    bodyContent.innerHTML = skills.map(skill => `
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 4px 0;
                            border-bottom: 1px solid rgba(255,255,255,0.05);
                        ">
                            <span style="color: rgba(255,255,255,0.9);">${skill.name}</span>
                            <span style="
                                background: rgba(255,145,35,0.2);
                                padding: 2px 8px;
                                border-radius: 4px;
                                color: #ff9123;
                                font-weight: 600;
                            ">${skill.value}/10</span>
                        </div>
                    `).join('');

                    // Add scroll if too many items
                    if (skills.length > 5) {
                        Object.assign(bodyContent.style, {
                            maxHeight: '200px',
                            overflowY: 'auto',
                            marginRight: '-6px',  // Compensate for scrollbar
                            paddingRight: '6px'
                        });
                    }
                }
            }
        }
        // Initialize application
        window.addEventListener('load', () => {
            UIManager.init();
            if (window.location.hostname.includes('netlify.app')) {
                const meta = document.createElement('meta');
                meta.httpEquiv = 'Content-Security-Policy';
                meta.content = "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://*.netlify.app https://cdnjs.cloudflare.com";
                document.head.appendChild(meta);
            }
        });

        window.addEventListener('error', (e) => {
            if (e.message.includes('html2pdf') || e.message.includes('jsPDF')) {
                ErrorHandler.handleError(new Error(e.message), 'pdf-generation');
            }
        }, true);

        document.getElementById('saveButton').addEventListener('click', () => {
            PDFManager.generatePDF(AssessmentDataManager.getAssessmentData());
        });

        // Export for testing
        if (typeof module !== 'undefined') {
            module.exports = {
                Utils,
                AssessmentDataManager,
                SkillsAnalyzer,
                UIManager,
                PDFManager,
                ChartManager,
                ErrorHandler
            };
        }
    </script>
</body>
</html>
